<!DOCTYPE html>
<html layout:decorate="~{_layouts/admin_layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${pageTitle} ?: 'ë„ì„œ í¼'"></title>
    <style>
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .form-section h3 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
            color: var(--admin-color-primary);
        }

        /* íŒì—… */
        .popup-small-overlay {
            position: absolute;
            z-index: 1000;
            width: 250px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            padding: 10px;
        }

        /* íŠ¸ë¦¬ ì „ìš© */
        .popup-small-overlay .popup-tree,
        .popup-small-overlay .popup-tree ul {
            list-style: none;
            margin: 0;
            padding: 0 0 0 1rem;
        }

        .popup-small-overlay .popup-tree > li {
            margin: 4px 0;
        }

        /* ì²´í¬ë°•ìŠ¤ ì„ íƒ ë¦¬ìŠ¤íŠ¸ */
        .popup-multi-select {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
        }

        .popup-multi-select li {
            margin: 5px 0;
        }

        .popup-multi-select input[type="checkbox"] {
            margin-right: 10px;
        }

        /* ì €ì¥ ë²„íŠ¼ */
        .popup-save-btn {
            display: block;
            width: 100%;
            margin-top: 10px;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px;
            text-align: center;
        }

        .popup-save-btn:hover {
            background-color: #0056b3;
        }

        .book-search-list:hover {
            background-color: #f1f9ff;
        }

    </style>
    <!-- â‘¡ ì„œë²„ì—ì„œ ë„˜ê¸´ ì¹´í…Œê³ ë¦¬ íŠ¸ë¦¬ë¥¼ JS ë³€ìˆ˜ë¡œ ì¸ë¼ì¸ ì§ë ¬í™” -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var categoryTree = /*[[${allCategoriesForMapping}]]*/ [];
        /*]]>*/
    </script>
</head>
<body>
<div layout:fragment="admin_content">
    <div class="admin-page-header">
        <h1 class="admin-page-title">
            <i class="fas fa-book-medical"></i>
            <th:block th:text="${pageTitle}"></th:block>
        </h1>
    </div>

    <div class="admin-panel">
        <div class="admin-panel__body">
            <div th:if="${globalErrorMessage}" class="alert alert-danger admin-alert">
                <strong th:text="${globalErrorMessage}"></strong>
            </div>

            <form th:action="@{/admin/aladin/books/save}" th:object="${aladinBookForm}" method="post"
                  enctype="multipart/form-data">

                <!-- ì•Œë¼ë”˜ ë„ì„œ ê²€ìƒ‰ -->
                <div class="aladin-search-container"
                     style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="aladinSearchInput" placeholder="ì•Œë¼ë”˜ ë„ì„œ ê²€ìƒ‰" class="admin-form-control"
                           style="width: 300px;">
                    <button type="button" class="admin-btn admin-btn--primary" onclick="searchAladinBooks()">ê²€ìƒ‰</button>
                </div>

                <div class="admin-panel">
                    <div class="admin-panel__body">

                        <!-- ì•Œë¼ë”˜ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ-->
                        <div id="aladinSearchResults" style="margin-bottom:20px; display:none;">
                            <h4>ê²€ìƒ‰ ê²°ê³¼</h4>
                            <ul id="aladinResultsList" style="list-style:none; padding:0;"></ul>
                        </div>
                        <div id="paginationControls" style="margin-top:10px;"></div>
                    </div>
                </div>

                <div id="selectedBookPreview" style="margin-top: 20px;"></div>

                <div id="aladinHiddenInputs">
                    <input type="hidden" name="isbn" id="isbnHidden">
                </div>


                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> ê¸°ë³¸ ì •ë³´</h3>
                    <div class="admin-form-group">
                        <label for="bookIndex" class="admin-form-label">ëª©ì°¨</label>
                        <textarea id="bookIndex" th:field="*{index}" class="admin-form-control" rows="5"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-dollar-sign"></i> íŒë§¤ ì •ë³´</h3>
                    <div class="row">
                        <div class="col-md-4 admin-form-group">
                            <label for="stock" class="admin-form-label">ì¬ê³  ìˆ˜ëŸ‰ <span class="text-danger">*</span></label>
                            <input type="number" id="stock" th:field="*{stock}" class="admin-form-control"
                                   th:errorclass="is-invalid">
                            <div th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}"
                                 class="invalid-feedback"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 admin-form-group">
                            <label for="saleState" class="admin-form-label">íŒë§¤ ìƒíƒœ <span
                                    class="text-danger">*</span></label>
                            <select id="saleState" th:field="*{state}" class="admin-form-control">
                                <option th:each="stateOpt : ${stateOptions}" th:value="${stateOpt}"
                                        th:text="${stateOpt}"></option>
                            </select>
                        </div>
                        <div class="col-md-6 admin-form-group">
                            <label class="admin-form-label">í¬ì¥ ê°€ëŠ¥ ì—¬ë¶€</label>
                            <div>
                                <input type="checkbox" id="isPackable" th:field="*{isPackable}"
                                       class="admin-form-check-input">
                                <label for="isPackable" class="admin-form-check-label">í¬ì¥ ê°€ëŠ¥</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-search"></i> ì¹´í…Œê³ ë¦¬ / íƒœê·¸ ì„ íƒ</h3>

                    <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
                    <div class="admin-form-group" style="position: relative;">
                        <label class="admin-form-label">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                        <button type="button" class="admin-form-control btn btn-primary"
                                onclick="openPopup('category')">
                            ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰
                        </button>
                        <div id="categoryPopup" class="popup-small-overlay" style="display:none;">
                            <!-- ê²€ìƒ‰ ì…ë ¥ ì œê±°, í˜ì´ì§€ë„¤ì´ì…˜ ì œê±° -->
                            <ul id="categoryResults" class="popup-tree"></ul>
                            <button type="button" class="popup-save-btn"
                                    onclick="saveSelection('category')">
                                í™•ì¸
                            </button>
                        </div>
                    </div>
                    <div id="categorySelectionDisplay"
                         style="margin-top:10px; font-size:14px; color:#333;">
                    </div>

                    <!-- íƒœê·¸ ì„ íƒ -->
                    <div class="admin-form-group" style="position: relative;">
                        <label class="admin-form-label">íƒœê·¸ ì„ íƒ</label>
                        <button type="button" class="admin-form-control btn btn-primary"
                                onclick="openPopup('tag')">
                            íƒœê·¸ ê²€ìƒ‰
                        </button>
                        <div id="tagPopup" class="popup-small-overlay" style="display:none;">
                            <input type="text" id="tagSearch"
                                   placeholder="íƒœê·¸ ê²€ìƒ‰" class="popup-input"
                                   onkeydown="if(event.key==='Enter'){ loadTags(0, tagSize, this.value); event.preventDefault(); }"/>
                            <ul id="tagResults" class="popup-multi-select"></ul>
                            <div id="tagPagination" class="pagination" style="text-align:center; margin-top:8px;"></div>
                            <button type="button" class="popup-save-btn" onclick="saveSelection('tag')">
                                í™•ì¸
                            </button>
                        </div>
                    </div>
                    <div id="tagSelectionDisplay" style="margin-top:10px; font-size:14px; color:#333;">
                    </div>


                    <div class="admin-form-actions mt-4 text-end">
                        <a th:href="@{/admin/books}"
                           class="admin-btn admin-btn--default"
                           style="margin-right:8px;">
                            ì·¨ì†Œ
                        </a>
                        <button type="submit" class="admin-btn admin-btn--primary">
                            <i class="fas fa-save"></i>
                            ë„ì„œ ë“±ë¡
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<th:block layout:fragment="page_scripts">
    <script th:inline="javascript">
        const MAX_PAGE = 3;
        const pageSize = 5;
        let currentPage = 0;

        // ì•Œë¼ë”˜ ë„ì„œ ê²€ìƒ‰
        async function searchAladinBooks(page = 0) {
            // page 1~MAX_PAGE ì‚¬ì´ë¡œ ì œí•œ
            page = Math.max(1, Math.min(page, MAX_PAGE));
            currentPage = page;

            const query = document.getElementById('aladinSearchInput').value.trim();
            if (!query) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì´ì „ ê²°ê³¼ ì´ˆê¸°í™”
            const resultsContainer = document.getElementById('aladinSearchResults');
            const resultsList = document.getElementById('aladinResultsList');
            resultsList.innerHTML = '';
            resultsContainer.style.display = 'none';

            // API í˜¸ì¶œ
            const res = await fetch(
                `/admin/aladin/books/aladin-search?keyword=${encodeURIComponent(query)}` +
                `&page=${page}&size=${pageSize}`,
                {headers: {'Accept': 'application/json'}}
            );
            const data = await res.json();
            const results = Array.isArray(data) ? data : (data.data || []);

            // ê²°ê³¼ê°€ ì—†ìœ¼ë©´
            if (results.length === 0) {
                alert('âœ… ë” ì´ìƒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                renderPaginationControls(page, false);
                return;
            }

            // ê²°ê³¼ ë Œë”ë§
            displayAladinSearchResults(results);

            // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ í™œì„±/ë¹„í™œì„±
            const hasNext = (results.length === pageSize) && (page < MAX_PAGE);
            renderPaginationControls(page, hasNext);
        }

        // ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ë¿Œë¦¬ê¸°
        function displayAladinSearchResults(results) {
            const resultsContainer = document.getElementById('aladinSearchResults');
            const resultsList = document.getElementById('aladinResultsList');
            resultsList.innerHTML = '';

            results.forEach(book => {
                const payload = encodeURIComponent(JSON.stringify(book));
                const li = document.createElement('li');
                li.style.marginBottom = '10px';
                li.style.cursor = 'pointer';
                li.dataset.payload = JSON.stringify(book);
                // li.setAttribute('onclick', `selectAladinBook('${payload}')`);
                li.innerHTML = `
                    <div class="book-search-list" style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; display: flex; gap: 1rem; transition: background-color 0.3s;">
                        <img src="${book.imgUrl}" alt="í‘œì§€" style="height: 150px; width: auto; border: 1px solid #ccc; border-radius: 4px; object-fit: contain;">
                        <div style="flex: 1;">
                              <h4 style="margin: 0 0 5px;">${book.title}</h4>
                              <p style="margin: 0;">ì €ì: ${book.author}</p>
                              <p style="margin: 0;">ì¶œíŒì‚¬: ${book.publisher}</p>
                              <p style="margin: 0;">ì¶œíŒì¼: ${book.publishDate}</p>
                              <p style="margin: 0;">ISBN: ${book.isbn}</p>
                              <p style="margin: 0;">ì¹´í…Œê³ ë¦¬: ${book.categoryName}</p>
                              <p style="margin: 0;">ì •ê°€: â‚©${book.price?.toLocaleString?.() ?? book.price}</p>
                              <p style="margin: 0;">íŒë§¤ê°€: â‚©${book.salePrice?.toLocaleString?.() ?? book.salePrice} (${book.salePercentage}% í• ì¸)</p>
                              <p style="margin: 0.5rem 0;">ì„¤ëª…: ${book.description?.slice(0, 100) ?? ''}...</p>
                        </div>
                    </div>
                `;
                li.addEventListener('click', function () {
                    selectAladinBook(this.dataset.payload); // ğŸ‘ˆ ì´ ë°©ì‹ìœ¼ë¡œ í˜¸ì¶œ
                });
                resultsList.appendChild(li);
            });

            resultsContainer.style.display = 'block';
        }

        // ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ í¼ì— ê°’ ì±„ìš°ê¸°
        function selectAladinBook(encoded) {
            const book = JSON.parse(decodeURIComponent(encoded));
            console.log(book);
            // ISBN ê°’ ì±„ìš°ê¸°
            document.getElementById('isbnHidden').value = book.isbn || '';

            // ì„ íƒëœ ë„ì„œ ì •ë³´ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì— í‘œì‹œ
            const preview = document.getElementById('selectedBookPreview');
            preview.innerHTML = `
                    <div style="border: 2px solid #007bff; padding: 15px; border-radius: 8px; display: flex; gap: 1rem; background: #f9f9f9;">
                        <img src="${book.imgUrl}" alt="í‘œì§€" style="height: 150px; border-radius: 4px; object-fit: contain;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px;">âœ… ì„ íƒëœ ë„ì„œ: ${book.title}</h4>
                            <p style="margin: 0;">ì €ì: ${book.author}</p>
                            <p style="margin: 0;">ì¶œíŒì‚¬: ${book.publisher}</p>
                            <p style="margin: 0;">ì¶œíŒì¼: ${book.publishDate}</p>
                            <p style="margin: 0;">ISBN: ${book.isbn}</p>
                            <p style="margin: 0;">ì¹´í…Œê³ ë¦¬: ${book.categoryName}</p>
                            <p style="margin: 0;">ì •ê°€: â‚©${book.price}</p>
                            <p style="margin: 0;">íŒë§¤ê°€: â‚©${book.salePrice} (${book.salePercentage}% í• ì¸)</p>
                            <p style="margin: 0.5rem 0;">ì„¤ëª…: ${book.description?.slice(0, 100)}...</p>
                        </div>
                    </div>
            `;
            highlightSelectedCard(book.isbn);
        }

        function highlightSelectedCard(isbn) {
            document.querySelectorAll('#aladinResultsList li').forEach(li => {
                if (li.innerHTML.includes(isbn)) {
                    li.style.border = '2px solid #007bff';
                    li.style.backgroundColor = '#e9f5ff';
                } else {
                    li.style.border = 'none';
                    li.style.backgroundColor = 'transparent';
                }
            });
        }

        // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ ë Œë”ë§
        function renderPaginationControls(page, hasNext) {
            const container = document.getElementById('paginationControls');
            const disablePrev = page <= 1;
            const disableNext = !hasNext;
            const totalPages = hasNext ? MAX_PAGE : page;

            container.innerHTML = `
        <button type="button" ${disablePrev ? 'disabled' : ''}
          onclick="searchAladinBooks(${page - 1})">
          Â« ì´ì „
        </button>
        <span style="margin:0 1rem;">í˜ì´ì§€ ${page} / ${totalPages}</span>
        <button type="button" ${disableNext ? 'disabled' : ''}
          onclick="searchAladinBooks(${page + 1})">
          ë‹¤ìŒ Â»
        </button>
      `;
        }

        // ê²€ìƒ‰ ë²„íŠ¼ ë°”ì¸ë”©
        document.querySelector('.admin-btn--primary')
            .addEventListener('click', () => searchAladinBooks(1));


        //ì¹´í…Œê³ ë¦¬, íƒœê·¸
        const tagSize = 10, tagKeyword = '';

        function renderCategoryTree(nodes, container) {
            nodes.forEach(node => {
                const li = document.createElement('li');
                if (node.children && node.children.length) {
                    li.textContent = node.name;
                    const childUl = document.createElement('ul');
                    renderCategoryTree(node.children, childUl);
                    li.appendChild(childUl);
                } else {
                    const label = document.createElement('label');
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.name = 'categoryIdList';
                    cb.value = node.id;
                    label.appendChild(cb);
                    label.append(` ${node.name}`);
                    li.appendChild(label);
                }
                container.appendChild(li);
            });
        }

        function loadTags(page, size, keyword) {
            fetch(`/admin/tags/search?page=${page}&size=${size}&searchKeyword=${encodeURIComponent(keyword)}`, {
                headers: {'Accept': 'application/json'}
            })
                .then(res => res.json())
                .then(data => {
                    const ul = document.getElementById('tagResults');
                    ul.innerHTML = data.content.map(t => `
  <li>
    <label>
     <input type="checkbox" name="tagIdList" value="${t.id}"/>
      ${t.name}
    </label>
  </li>
      `).join('');
                    // í˜ì´ì§•
                    const pag = document.getElementById('tagPagination');
                    let html = '';
                    if (data.pageable.pageNumber > 0) {
                        html += `<button onclick="loadTags(${data.pageable.pageNumber - 1},${size},'${keyword}')">&laquo;</button>`;
                    }
                    for (let i = 0; i < data.totalPages; i++) {
                        html += `<button class="${i === data.pageable.pageNumber ? 'active' : ''}"
                    onclick="loadTags(${i},${size},'${keyword}')">${i + 1}</button>`;
                    }
                    if (data.pageable.pageNumber < data.totalPages - 1) {
                        html += `<button onclick="loadTags(${data.pageable.pageNumber + 1},${size},'${keyword}')">&raquo;</button>`;
                    }
                    pag.innerHTML = html;
                })
                .catch(console.error);
        }


        // íŒì—… ì—´ê¸°: ì¹´í…Œê³ ë¦¬ë©´ íŠ¸ë¦¬ ë Œë”, ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ ë¡œë”©
        function openPopup(type) {
            closeAllPopups();
            const popup = document.getElementById(type + 'Popup');
            popup.style.display = 'block';
            if (type === 'category') {
                const ul = document.getElementById('categoryResults');
                ul.innerHTML = '';
                renderCategoryTree(categoryTree, ul);
            } else if (type === 'publisher') {
                loadPublishers(0, pubSize, pubKeyword);
            } else if (type === 'author') {
                loadAuthors(0, authSize, authKeyword);
            } else if (type === 'tag') {
                loadTags(0, tagSize, tagKeyword);
            }
        }

        function closeAllPopups() {
            document.querySelectorAll('.popup-small-overlay').forEach(p => p.style.display = 'none');
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.popup-small-overlay, .btn')) closeAllPopups();
        });

        function saveSelection(type) {
            const popup = document.getElementById(type + 'Popup');
            const checked = popup.querySelectorAll('input[type="checkbox"]:checked');

            // hidden inputs ì¬ìƒì„±
            let hiddenContainer = document.getElementById(type + 'HiddenInputs');

            if (!hiddenContainer) {
                hiddenContainer = document.createElement('div');
                hiddenContainer.id = type + 'HiddenInputs';
                document.querySelector('form').appendChild(hiddenContainer);
            }
            hiddenContainer.innerHTML = '';
            checked.forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = type + 'IdList';
                input.value = cb.value;
                hiddenContainer.appendChild(input);
            });

            // ì„ íƒëœ ì´ë¦„ í‘œì‹œ
            const texts = Array.from(checked).map(cb => cb.parentNode.textContent.trim());
            document.getElementById(type + 'SelectionDisplay').innerHTML =
                texts.length
                    ? `<strong>ì„ íƒëœ ${type}:</strong> ${texts.join(', ')}`
                    : `<strong>ì„ íƒëœ ${type}:</strong> ì—†ìŒ`;

            closeAllPopups();
        }


        ['category'].forEach(type => {
            document.getElementById(type + 'Search').addEventListener('input', () => {
                const q = document.getElementById(type + 'Search').value.toLowerCase();
                document.querySelectorAll(`#${type}Results li`).forEach(li => {
                    li.style.display = li.textContent.toLowerCase().includes(q) ? 'block' : 'none';
                });
            });
        });

    </script>
</th:block>


</body>
</html>
<!DOCTYPE html>
<html layout:decorate="~{_layouts/admin_layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
    <title th:text="${pageTitle} ?: '도서 폼'"></title>
    <style>
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .form-section h3 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
            color: var(--admin-color-primary);
        }

        /* 팝업 */
        .popup-small-overlay {
            position: absolute;
            z-index: 1000;
            width: 250px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            padding: 10px;
        }

        /* 트리 전용 */
        .popup-small-overlay .popup-tree,
        .popup-small-overlay .popup-tree ul {
            list-style: none;
            margin: 0;
            padding: 0 0 0 1rem;
        }

        .popup-small-overlay .popup-tree > li {
            margin: 4px 0;
        }

        /* 체크박스 선택 리스트 */
        .popup-multi-select {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
        }

        .popup-multi-select li {
            margin: 5px 0;
        }

        .popup-multi-select input[type="checkbox"] {
            margin-right: 10px;
        }

        /* 저장 버튼 */
        .popup-save-btn {
            display: block;
            width: 100%;
            margin-top: 10px;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px;
            text-align: center;
        }

        .popup-save-btn:hover {
            background-color: #0056b3;
        }

    </style>
    <!-- ② 서버에서 넘긴 카테고리 트리를 JS 변수로 인라인 직렬화 -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var categoryTree = /*[[${allCategoriesForMapping}]]*/ [];
        /*]]>*/
    </script>
</head>
<body>
<div layout:fragment="admin_content">
    <div class="admin-page-header">
        <h1 class="admin-page-title">
            <i class="fas fa-book-medical"></i>
            <th:block th:text="${pageTitle}"></th:block>
        </h1>
    </div>

    <div class="admin-panel">
        <div class="admin-panel__body">
            <div th:if="${globalErrorMessage}" class="alert alert-danger admin-alert">
                <strong th:text="${globalErrorMessage}"></strong>
            </div>

            <form th:action="@{/admin/books/save}" th:object="${book}" method="post" enctype="multipart/form-data">
                <!--                <input type="hidden" th:field="*{id}"/>-->
                <!--                <input type="hidden" th:field="*{deletedAt}"/>-->

                <!-- 알라딘 도서 검색 -->
                <div class="aladin-search-container"
                     style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="aladinSearchInput" placeholder="알라딘 도서 검색" class="admin-form-control"
                           style="width: 300px;">
                    <button type="button" class="admin-btn admin-btn--primary" onclick="searchAladinBooks()">검색</button>
                </div>

                <div class="admin-panel">
                    <div class="admin-panel__body">

                        <!-- 알라딘 검색 결과 표시-->
                        <div id="aladinSearchResults" style="margin-bottom:20px; display:none;">
                            <h4>검색 결과</h4>
                            <ul id="aladinResultsList" style="list-style:none; padding:0;"></ul>
                        </div>
                        <div id="paginationControls" style="margin-top:10px;"></div>
                    </div>
                </div>


                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> 기본 정보</h3>
                    <div class="row">
                        <div class="col-md-8 admin-form-group">
                            <label for="title" class="admin-form-label">도서 제목 <span class="text-danger">*</span></label>
                            <input type="text" id="title" th:field="*{title}" class="admin-form-control"
                                   th:errorclass="is-invalid">
                            <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}"
                                 class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4 admin-form-group">
                            <label for="isbn" class="admin-form-label">ISBN <span class="text-danger">*</span></label>
                            <input type="text" id="isbn" th:field="*{isbn}" class="admin-form-control"
                                   th:errorclass="is-invalid" placeholder="13자리 숫자">
                            <div th:if="${#fields.hasErrors('isbn')}" th:errors="*{isbn}"
                                 class="invalid-feedback"></div>
                        </div>
                    </div>
                    <div class="admin-form-group">
                        <label for="bookIndex" class="admin-form-label">목차</label>
                        <textarea id="bookIndex" th:field="*{index}" class="admin-form-control" rows="5"></textarea>
                    </div>
                    <div class="admin-form-group">
                        <label for="description" class="admin-form-label">
                            상세 설명 <span class="text-danger">*</span>
                        </label>
                        <textarea id="description"
                                  th:field="*{description}"
                                  class="admin-form-control"
                                  rows="10"></textarea>
                        <div th:if="${#fields.hasErrors('description')}"
                             th:errors="*{description}"
                             class="invalid-feedback"></div>
                    </div>

                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            const descEl = document.getElementById('description');
                            if (!descEl) {
                                return console.error('❌ description textarea not found');
                            }
                            if (!window.ClassicEditor) {
                                return console.error('❌ CKEditor script missing');
                            }
                            ClassicEditor
                                .create(descEl)
                                .then(editor => console.log('✅ CKEditor ready'))
                                .catch(err => console.error('❌ CKEditor init error:', err));
                        });
                    </script>
                    <div class="admin-form-group">
                        <label for="publishDate" class="admin-form-label">출판일</label>
                        <input type="date" id="publishDate" th:field="*{publishDate}" class="admin-form-control">
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-dollar-sign"></i> 판매 정보</h3>
                    <div class="row">
                        <div class="col-md-4 admin-form-group">
                            <label for="price" class="admin-form-label">정가 <span
                                    class="text-danger">*</span></label>
                            <input type="number" id="price" th:field="*{price}" class="admin-form-control"
                                   th:errorclass="is-invalid">
                            <div th:if="${#fields.hasErrors('price')}" th:errors="*{price}"
                                 class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4 admin-form-group">
                            <label for="salePrice" class="admin-form-label">판매가 <span
                                    class="text-danger">*</span></label>
                            <input type="number" id="salePrice" th:field="*{salePrice}" class="admin-form-control"
                                   th:errorclass="is-invalid">
                            <div th:if="${#fields.hasErrors('salePrice')}" th:errors="*{salePrice}"
                                 class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4 admin-form-group">
                            <label for="stock" class="admin-form-label">재고 수량 <span class="text-danger">*</span></label>
                            <input type="number" id="stock" th:field="*{stock}" class="admin-form-control"
                                   th:errorclass="is-invalid">
                            <div th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}"
                                 class="invalid-feedback"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 admin-form-group">
                            <label for="saleState" class="admin-form-label">판매 상태 <span
                                    class="text-danger">*</span></label>
                            <select id="saleState" th:field="*{state}" class="admin-form-control">
                                <option th:each="stateOpt : ${stateOptions}" th:value="${stateOpt}"
                                        th:text="${stateOpt}"></option>
                            </select>
                        </div>
                        <div class="col-md-6 admin-form-group">
                            <label class="admin-form-label">포장 가능 여부</label>
                            <div>
                                <input type="checkbox" id="isPackable" th:field="*{isPackable}"
                                       class="admin-form-check-input">
                                <label for="isPackable" class="admin-form-check-label">포장 가능</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-search"></i> 카테고리 / 작가 / 출판사 / 태그 선택</h3>

                    <!-- 카테고리 선택 -->
                    <!-- 카테고리 선택 -->
                    <div class="admin-form-group" style="position: relative;">
                        <label class="admin-form-label">카테고리 선택</label>
                        <button type="button" class="admin-form-control btn btn-primary"
                                onclick="openPopup('category')">
                            카테고리 검색
                        </button>
                        <div id="categoryPopup" class="popup-small-overlay" style="display:none;">
                            <!-- 검색 입력 제거, 페이지네이션 제거 -->
                            <ul id="categoryResults" class="popup-tree"></ul>
                            <button type="button" class="popup-save-btn"
                                    onclick="saveSelection('category')">
                                확인
                            </button>
                        </div>
                    </div>
                    <div id="categorySelectionDisplay"
                         style="margin-top:10px; font-size:14px; color:#333;">
                    </div>


                    <!-- 작가 선택 -->
                    <div class="admin-form-group" style="position: relative;">
                        <label class="admin-form-label">작가 선택</label>
                        <button type="button" class="admin-form-control btn btn-primary"
                                onclick="openPopup('author')">
                            작가 검색
                        </button>
                        <div id="authorPopup" class="popup-small-overlay" style="display:none;">
                            <input type="text" id="authorSearch"
                                   placeholder="작가 검색" class="popup-input"
                                   onkeydown="if(event.key==='Enter'){ loadAuthors(0, authSize, this.value); event.preventDefault(); }"/>
                            <ul id="authorResults" class="popup-multi-select"></ul>
                            <div id="authorPagination" class="pagination"
                                 style="text-align:center; margin-top:8px;"></div>
                            <button type="button" class="popup-save-btn" onclick="saveSelection('author')">
                                확인
                            </button>
                        </div>
                    </div>
                    <div id="authorSelectionDisplay"
                         style="margin-top:10px; font-size:14px; color:#333;">
                    </div>

                    <!-- 출판사 선택 -->
                    <div class="admin-form-group" style="position: relative;">
                        <label class="admin-form-label">출판사 선택</label>
                        <button type="button"
                                class="admin-form-control btn btn-primary"
                                onclick="openPopup('publisher')">
                            출판사 검색
                        </button>

                        <div id="publisherPopup" class="popup-small-overlay" style="display:none;">
                            <input type="text" id="publisherSearch"
                                   placeholder="출판사 검색"
                                   class="popup-input"
                                   onkeydown="if(event.key==='Enter'){ loadPublishers(0,pubSize,this.value); event.preventDefault(); }"/>
                            <ul id="publisherResults" class="popup-multi-select"></ul>
                            <div id="publisherPagination" class="pagination"
                                 style="text-align:center; margin-top:8px;"></div>
                            <button type="button" class="popup-save-btn" onclick="saveSelection('publisher')">
                                확인
                            </button>
                        </div>
                    </div>

                    <div id="publisherSelectionDisplay"
                         style="margin-top:10px; font-size:14px; color:#333;">
                    </div>


                    <!-- 태그 선택 -->
                    <div class="admin-form-group" style="position: relative;">
                        <label class="admin-form-label">태그 선택</label>
                        <button type="button" class="admin-form-control btn btn-primary"
                                onclick="openPopup('tag')">
                            태그 검색
                        </button>
                        <div id="tagPopup" class="popup-small-overlay" style="display:none;">
                            <input type="text" id="tagSearch"
                                   placeholder="태그 검색" class="popup-input"
                                   onkeydown="if(event.key==='Enter'){ loadTags(0, tagSize, this.value); event.preventDefault(); }"/>
                            <ul id="tagResults" class="popup-multi-select"></ul>
                            <div id="tagPagination" class="pagination" style="text-align:center; margin-top:8px;"></div>
                            <button type="button" class="popup-save-btn" onclick="saveSelection('tag')">
                                확인
                            </button>
                        </div>
                    </div>
                    <div id="tagSelectionDisplay" style="margin-top:10px; font-size:14px; color:#333;">
                    </div>

                    <div class="admin-form-group">
                        <label for="bookImage" class="admin-form-label">도서 이미지</label>
                        <input type="file" id="bookImage" accept="image/*" class="admin-form-control"/>
                        <button type="button" onclick="uploadImageToPresignedUrl()">이미지 업로드</button>
                    </div>

                    <!-- 업로드된 이미지 URL을 서버로 보낼 hidden input -->
                    <label for="presignedUploadUrl"></label>
                    <input type="hidden" readonly name="presignedUploadUrl" th:value="${presignedUploadUrl}"
                           id="presignedUploadUrl" th:hidden/>
                    <input type="hidden" th:field="*{imgUrl}" id="imgUrl"/>
                    <input type="hidden" readonly name="uploadedImageUrl" id="uploadedImageUrl"/>

                    <!-- 업로드 미리보기 -->
                    <div id="uploadedImagePreview" style="margin-top: 10px;"></div>

                    <div class="admin-form-actions mt-4 text-end">
                        <a th:href="@{/admin/books}"
                           class="admin-btn admin-btn--default"
                           style="margin-right:8px;">
                            취소
                        </a>
                        <button type="submit" class="admin-btn admin-btn--primary">
                            <i class="fas fa-save"></i>
                            도서 등록
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<th:block layout:fragment="page_scripts">
    <script th:inline="javascript">
        // 알라딘 도서 검색
        const MAX_PAGE = 3;
        const pageSize = 10;
        let currentPage = 1;

        // 알라딘 도서 검색
        async function searchAladinBooks(page = 1) {
            // 1 ≤ page ≤ MAX_PAGE 고정
            page = Math.max(1, Math.min(page, MAX_PAGE));
            currentPage = page;

            const query = document.getElementById('aladinSearchInput').value.trim();
            if (!query) {
                alert('검색어를 입력해주세요.');
                return;
            }

            // 이전 결과 완전 초기화
            const resultsContainer = document.getElementById('aladinSearchResults');
            const resultsList = document.getElementById('aladinResultsList');
            resultsList.innerHTML = '';
            resultsContainer.style.display = 'none';

            // API 호출
            const res = await fetch(
                `/admin/books/aladin-search?keyword=${encodeURIComponent(query)}` +
                `&page=${page}&size=${pageSize}`,
                {headers: {'Accept': 'application/json'}}
            );
            const data = await res.json();
            const results = Array.isArray(data) ? data : (data.data || []);

            // 결과 없으면
            if (results.length === 0) {
                alert('✅ 더 이상 검색 결과가 없습니다.');
                // 빈 상태로 유지
                resultsList.innerHTML = '';
                resultsContainer.style.display = 'none';
                // hasNext = false → 페이지  currentPage / currentPage
                renderPaginationControls(page, false);
                return;
            }

            // 결과 렌더링
            displayAladinSearchResults(results);

            // 다음페이지 여부 판단
            const hasNext = (results.length === pageSize) && (page < MAX_PAGE);
            renderPaginationControls(page, hasNext);
        }

        // 검색 결과 표시
        function displayAladinSearchResults(results) {
            const resultsContainer = document.getElementById('aladinSearchResults');
            const resultsList = document.getElementById('aladinResultsList');
            resultsList.innerHTML = '';  // 안전하게 클리어

            results.forEach(book => {
                const payload = encodeURIComponent(JSON.stringify(book));
                const li = document.createElement('li');
                li.style.marginBottom = '10px';
                li.innerHTML = `
          <strong>${book.title}</strong><br>
          저자: ${book.author}, 출판사: ${book.publisher}, ISBN: ${book.isbn}<br>
          <button
            type="button"
            class="admin-btn admin-btn--default"
            style="margin-top:5px;"
            onclick="selectAladinBook('${payload}')">
            선택
          </button>
        `;
                resultsList.appendChild(li);
            });

            resultsContainer.style.display = 'block';
        }

        // 선택 버튼 클릭 핸들러
        function selectAladinBook(encoded) {
            const book = JSON.parse(decodeURIComponent(encoded));
            document.getElementById('title').value = book.title || '';
            document.getElementById('isbn').value = book.isbn || '';
            document.getElementById('description').value = book.description || '';
            document.getElementById('publishDate').value = book.publishDate || '';
        }

        // 페이징 컨트롤 렌더링
        function renderPaginationControls(page, hasNext) {
            const container = document.getElementById('paginationControls');
            const disablePrev = page <= 1;
            const disableNext = !hasNext;
            // 결과가 한 페이지만 있을 땐 totalPages = page;
            const totalPages = hasNext ? MAX_PAGE : page;

            container.innerHTML = `
        <button type="button" ${disablePrev ? 'disabled' : ''}
          onclick="searchAladinBooks(${page - 1})">
          « 이전
        </button>
        <span style="margin:0 1rem;">
          페이지 ${page} / ${totalPages}
        </span>
        <button type="button" ${disableNext ? 'disabled' : ''}
          onclick="searchAladinBooks(${page + 1})">
          다음 »
        </button>
      `;
        }

        // 검색 버튼 바인딩
        document.querySelector('.admin-btn--primary')
            .addEventListener('click', () => searchAladinBooks(1));

        // 페이지가 로드된 직후, 만약 pubPage 쿼리 파라미터가 있으면 팝업을 열어두자
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URL(location).searchParams;
            if (params.has('pubPage') || params.has('pubKeyword')) {
                openPopup('publisher');
            }
        });

        //카테고리, 작가, 출판사, 태그

        const pubSize = 10, pubKeyword = '';
        const authSize = 10, authKeyword = '';
        const tagSize = 10, tagKeyword = '';

        function renderCategoryTree(nodes, container) {
            nodes.forEach(node => {
                const li = document.createElement('li');
                if (node.children && node.children.length) {
                    li.textContent = node.name;
                    const childUl = document.createElement('ul');
                    renderCategoryTree(node.children, childUl);
                    li.appendChild(childUl);
                } else {
                    const label = document.createElement('label');
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.name = 'categoryIdList';
                    cb.value = node.id;
                    label.appendChild(cb);
                    label.append(` ${node.name}`);
                    li.appendChild(label);
                }
                container.appendChild(li);
            });
        }

        function loadPublishers(page, size, keyword) {
            fetch(`/admin/chulpansa/search?page=${page}&size=${size}&searchKeyword=${encodeURIComponent(keyword)}`, {
                headers: {'Accept': 'application/json'}
            })
                .then(res => res.json())
                .then(data => {
                    // 체크박스 리스트 갱신…
                    const ul = document.getElementById('publisherResults');
                    ul.innerHTML = data.content.map(pub => `
  <li>
    <label>
      <input type="checkbox" name="publisherIdList" value="${pub.id}"/>
      ${pub.name}
    </label>
  </li>
`).join('');


                    // 페이징 UI 갱신…
                    const pag = document.getElementById('publisherPagination');
                    let html = '';
                    if (data.pageable.pageNumber > 0) {
                        html += `<button type="button" onclick="loadPublishers(${data.pageable.pageNumber - 1},${size},'${keyword}')">&laquo; 이전</button>`;
                    }
                    for (let i = 0; i < data.totalPages; i++) {
                        html += `<button type="button" class="${i === data.pageable.pageNumber ? 'active' : ''}"
                    onclick="loadPublishers(${i},${size},'${keyword}')">${i + 1}</button>`;
                    }
                    if (data.pageable.pageNumber < data.totalPages - 1) {
                        html += `<button type="button" onclick="loadPublishers(${data.pageable.pageNumber + 1},${size},'${keyword}')">다음 &raquo;</button>`;
                    }
                    pag.innerHTML = html;
                });
        }

        function loadAuthors(page, size, keyword) {
            fetch(`/admin/authors/search?page=${page}&size=${size}&searchKeyword=${encodeURIComponent(keyword)}`, {
                headers: {'Accept': 'application/json'}
            })
                .then(res => res.json())
                .then(data => {
                    const ul = document.getElementById('authorResults');
                    ul.innerHTML = data.content.map(a => `
  <li>
    <label>
      <input type="checkbox" name="authorIdList" value="${a.id}"/>
      ${a.name}
    </label>
  </li>
      `).join('');
                    // 페이징 버튼
                    const pag = document.getElementById('authorPagination');
                    let html = '';
                    if (data.pageable.pageNumber > 0) {
                        html += `<button onclick="loadAuthors(${data.pageable.pageNumber - 1},${size},'${keyword}')">&laquo;</button>`;
                    }
                    for (let i = 0; i < data.totalPages; i++) {
                        html += `<button class="${i === data.pageable.pageNumber ? 'active' : ''}"
                    onclick="loadAuthors(${i},${size},'${keyword}')">${i + 1}</button>`;
                    }
                    if (data.pageable.pageNumber < data.totalPages - 1) {
                        html += `<button onclick="loadAuthors(${data.pageable.pageNumber + 1},${size},'${keyword}')">&raquo;</button>`;
                    }
                    pag.innerHTML = html;
                })
        }

        function loadTags(page, size, keyword) {
            fetch(`/admin/tags/search?page=${page}&size=${size}&searchKeyword=${encodeURIComponent(keyword)}`, {
                headers: {'Accept': 'application/json'}
            })
                .then(res => res.json())
                .then(data => {
                    const ul = document.getElementById('tagResults');
                    ul.innerHTML = data.content.map(t => `
  <li>
    <label>
     <input type="checkbox" name="tagIdList" value="${t.id}"/>
      ${t.name}
    </label>
  </li>
      `).join('');
                    // 페이징
                    const pag = document.getElementById('tagPagination');
                    let html = '';
                    if (data.pageable.pageNumber > 0) {
                        html += `<button onclick="loadTags(${data.pageable.pageNumber - 1},${size},'${keyword}')">&laquo;</button>`;
                    }
                    for (let i = 0; i < data.totalPages; i++) {
                        html += `<button class="${i === data.pageable.pageNumber ? 'active' : ''}"
                    onclick="loadTags(${i},${size},'${keyword}')">${i + 1}</button>`;
                    }
                    if (data.pageable.pageNumber < data.totalPages - 1) {
                        html += `<button onclick="loadTags(${data.pageable.pageNumber + 1},${size},'${keyword}')">&raquo;</button>`;
                    }
                    pag.innerHTML = html;
                })
                .catch(console.error);
        }


        // 팝업 열기: 카테고리면 트리 렌더, 나머지는 기존 로딩
        function openPopup(type) {
            closeAllPopups();
            const popup = document.getElementById(type + 'Popup');
            popup.style.display = 'block';
            if (type === 'category') {
                const ul = document.getElementById('categoryResults');
                ul.innerHTML = '';
                renderCategoryTree(categoryTree, ul);
            } else if (type === 'publisher') {
                loadPublishers(0, pubSize, pubKeyword);
            } else if (type === 'author') {
                loadAuthors(0, authSize, authKeyword);
            } else if (type === 'tag') {
                loadTags(0, tagSize, tagKeyword);
            }
        }

        function closeAllPopups() {
            document.querySelectorAll('.popup-small-overlay').forEach(p => p.style.display = 'none');
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.popup-small-overlay, .btn')) closeAllPopups();
        });

        function saveSelection(type) {
            const popup = document.getElementById(type + 'Popup');
            const checked = popup.querySelectorAll('input[type="checkbox"]:checked');

            // hidden inputs 재생성
            let hiddenContainer = document.getElementById(type + 'HiddenInputs');

            if (!hiddenContainer) {
                hiddenContainer = document.createElement('div');
                hiddenContainer.id = type + 'HiddenInputs';
                document.querySelector('form').appendChild(hiddenContainer);
            }
            hiddenContainer.innerHTML = '';
            checked.forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = type + 'IdList';
                input.value = cb.value;
                hiddenContainer.appendChild(input);
            });

            // 선택된 이름 표시
            const texts = Array.from(checked).map(cb => cb.parentNode.textContent.trim());
            document.getElementById(type + 'SelectionDisplay').innerHTML =
                texts.length
                    ? `<strong>선택된 ${type}:</strong> ${texts.join(', ')}`
                    : `<strong>선택된 ${type}:</strong> 없음`;

            closeAllPopups();
        }


        ['category', 'author', 'publisher'].forEach(type => {
            document.getElementById(type + 'Search').addEventListener('input', () => {
                const q = document.getElementById(type + 'Search').value.toLowerCase();
                document.querySelectorAll(`#${type}Results li`).forEach(li => {
                    li.style.display = li.textContent.toLowerCase().includes(q) ? 'block' : 'none';
                });
            });
        });

        // Presigned URL을 이용한 단일 이미지 업로드
        async function uploadImageToPresignedUrl() {
            const fileInput = document.getElementById("bookImage");
            const file = fileInput.files[0];
            if (!file) {
                alert("이미지를 선택하세요.");
                return;
            }
            const presignedUrl = document.getElementById("presignedUploadUrl").value;
            try {
                const res = await fetch(presignedUrl, {
                    method: "PUT",
                    headers: {"Content-Type": file.type},
                    body: file
                });
                if (!res.ok) throw new Error("Upload failed");

                const imageUrl = presignedUrl.split("?")[0];
                document.getElementById("uploadedImageUrl").value = imageUrl;
                document.getElementById("imgUrl").value = imageUrl;
                document.getElementById("uploadedImagePreview").innerHTML = `
                    <img src="${imageUrl}"
                         style="width:180px;
                                border:2px solid #007bff;
                                padding:6px;
                                border-radius:6px;" />
                    <div style="margin-top:5px;
                                font-size:14px;
                                color:green;">
                        이미지 업로드 완료
                    </div>`;
                fileInput.value = "";
            } catch (err) {
                console.error(err);
                alert("업로드 중 오류 발생");
            }
        }
    </script>
</th:block>


</body>
</html>
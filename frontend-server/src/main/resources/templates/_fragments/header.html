<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<header class="site-header-kitsch" th:fragment="headerFragment">
    <div class="container-kitsch">
        <div class="header-flex-kitsch">
            <a class="logo-link-kitsch" href="/" th:href="@{/}">
                <h1 class="logo-main-kitsch display-font-kitsch">Blue<span class="logo-alt-color-kitsch">Book</span>tle
                </h1>
                <p class="logo-sub-kitsch handwriting-font-kitsch">ë‹¹ì‹ ì„ ìœ„í•œ ì„œì </p>
            </a>

            <!-- ì—¬ê¸°ì— ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜ ì¶”ê°€ -->
            <button type="button"
                    class="btn-kitsch secondary-btn-kitsch color1-kitsch retro-shadow-kitsch-small categories-btn-header-kitsch"
                    title="ì¹´í…Œê³ ë¦¬ ë³´ê¸°">
                <i class="fas fa-bars"></i>
            </button>

            <form action="/books" class="header-search-form-kitsch" method="get" th:action="@{/books}">
                <input class="input-kitsch header-search-input-kitsch" name="searchKeyword" placeholder="ë ˆíŠ¸ë¡œ ê°ì„± ì±… ê²€ìƒ‰!"
                       type="text" value="">
                <button class="btn-kitsch primary-btn-kitsch header-search-btn-kitsch" type="submit">
                    <i class="fas fa-search"></i>
                </button>
            </form>

            <div class="user-actions-kitsch logged-in-actions-kitsch" th:if="${isLoggedIn}">
                <a class="btn-kitsch secondary-btn-kitsch color3-kitsch retro-shadow-kitsch-small cart-btn-header-kitsch"
                   href="/cart" th:href="@{/cart}">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count-kitsch" th:if="${cartItemCount > 0}" th:text="${cartItemCount}">0</span>
                </a>

                <a th:if="${userType == 'ADMIN'}"
                   class="btn-kitsch secondary-btn-kitsch color1-kitsch retro-shadow-kitsch-small"
                   th:href="@{/admin/dashboard}"> <i class="fas fa-cogs"></i>
                    <span th:text="ê´€ë¦¬ì"></span>
                </a>

                <a class="btn-kitsch secondary-btn-kitsch color1-kitsch retro-shadow-kitsch-small"
                   th:href="@{/mypage/profile}">
                    <i class="fas fa-user-astronaut"></i>
                    <span th:text="ë§ˆì´í˜ì´ì§€"></span>
                </a>

                <form th:action="@{/logout}" method="get" style="display: inline;">
                    <button type="submit"
                            class="btn-kitsch secondary-btn-kitsch color4-kitsch retro-shadow-kitsch-small logout-button-as-link">
                        <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="category-container">
        <div class="categories-panel-kitsch">
            <div class="category-tree-container"></div>
        </div>
    </div>
    <div class="header-marquee-kitsch" th:if="${isLoggedIn}">
        <p class="pixel-font-kitsch" th:if="${userNickname != null}"
           th:text="'ğŸ‰ ' + ${userNickname} + 'ë‹˜, ì˜¤ëŠ˜ì˜ ì±…ì„ ì°¾ì•„ë³¼ê¹Œìš”? ğŸ‘¾ ì¿ í° ì´ë²¤íŠ¸ í™•ì¸!'"></p>
        <p class="pixel-font-kitsch" th:if="${userNickname == null}"
           th:text="'ğŸ‰ íšŒì›ë‹˜, ì˜¤ëŠ˜ì€ ì–´ë–¤ ì±…ì„ ì°¾ì•„ë³¼ê¹Œìš”? ğŸ‘¾ ì¿ í° ì´ë²¤íŠ¸ í™•ì¸!'"></p>
    </div>

    <script>
        document.querySelectorAll('.categories-btn-header-kitsch').forEach(btn => {
            const panel = btn.closest('.site-header-kitsch')
                .querySelector('.categories-panel-kitsch');
            const icon = btn.querySelector('i');

            btn.addEventListener('click', e => {
                e.preventDefault();
                const isOpen = panel.classList.toggle('active');
                btn.setAttribute('aria-expanded', isOpen);

                if (isOpen) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });

            // ë°– í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', e => {
                if (!btn.contains(e.target) && !panel.contains(e.target)) {
                    panel.classList.remove('active');
                    btn.setAttribute('aria-expanded', 'false');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
        });
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const data = /*[[${categoryTree}]]*/ [];

        /*]]>*/

        function makeTree(nodes) {
            return nodes.map(cat => {
                const detail = document.createElement('details');
                const sum = document.createElement('summary');

                // leaf ë©´ í´ë˜ìŠ¤ ë‹¬ê¸°
                if (!cat.children || cat.children.length === 0) {
                    detail.classList.add('leaf-category');
                }

                // existing arrow + toggle ë¡œì§â€¦
                if (cat.children && cat.children.length) {
                    const arrow = document.createElement('i');
                    arrow.className = 'fas fa-chevron-right arrow-icon';
                    sum.appendChild(arrow);
                    detail.addEventListener('toggle', () => {
                        arrow.classList.replace(
                            detail.open ? 'fa-chevron-right' : 'fa-chevron-down',
                            detail.open ? 'fa-chevron-down' : 'fa-chevron-right'
                        );
                    });
                }

                // ğŸ“– ì•„ì´ì½˜ + ë§í¬
                const link = document.createElement('a');
                link.href = `/categories/${cat.id}`;            // ì‹¤ì œ ì¹´í…Œê³ ë¦¬ URL íŒ¨í„´ì— ë§ê²Œ ìˆ˜ì •
                link.innerHTML = `ğŸ“– ${cat.name}`;
                link.classList.add('category-link-kitsch');     // í•„ìš”í•˜ë‹¤ë©´ ìŠ¤íƒ€ì¼ìš© í´ë˜ìŠ¤
                // í´ë¦­í•´ë„ details í† ê¸€ì€ ë§‰ê¸°
                link.addEventListener('click', e => e.stopPropagation());
                sum.appendChild(link);

                detail.appendChild(sum);

                // 3) ì¬ê·€ ìì‹ ì²˜ë¦¬
                if (cat.children && cat.children.length) {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('categories-list-nested');
                    makeTree(cat.children).forEach(child => wrapper.appendChild(child));
                    detail.appendChild(wrapper);
                }

                return detail;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.category-tree-container');
            makeTree(data).forEach(el => container.appendChild(el));
        });

    </script>

</header>

<header class="site-header-kitsch" th:fragment="headerFragmentLoggedOut">
    <div class="container-kitsch">
        <div class="header-flex-kitsch">
            <a class="logo-link-kitsch" href="/" th:href="@{/}">
                <h1 class="logo-main-kitsch display-font-kitsch">Blue<span class="logo-alt-color-kitsch">Book</span>tle
                </h1>
                <p class="logo-sub-kitsch handwriting-font-kitsch">ë‹¹ì‹ ì„ ìœ„í•œ ì„œì </p>
            </a>

            <!-- ì—¬ê¸°ì— ì¹´í…Œê³ ë¦¬ ì•„ì´ì½˜ ì¶”ê°€ -->
            <button type="button"
                    class="btn-kitsch secondary-btn-kitsch color1-kitsch retro-shadow-kitsch-small categories-btn-header-kitsch"
                    title="ì¹´í…Œê³ ë¦¬ ë³´ê¸°">
                <i class="fas fa-bars"></i>
            </button>

            <form action="/books" class="header-search-form-kitsch" method="get" th:action="@{/books}">
                <input class="input-kitsch header-search-input-kitsch" name="searchKeyword" placeholder="ë ˆíŠ¸ë¡œ ê°ì„± ì±… ê²€ìƒ‰!"
                       type="text" value="">
                <button class="btn-kitsch primary-btn-kitsch header-search-btn-kitsch" type="submit">
                    <i class="fas fa-search"></i>
                </button>
            </form>

            <div class="user-actions-kitsch">
                <a class="btn-kitsch secondary-btn-kitsch color3-kitsch retro-shadow-kitsch-small cart-btn-header-kitsch"
                   href="/cart" th:href="@{/cart}">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count-kitsch" th:if="${cartItemCount > 0}" th:text="${cartItemCount}">0</span>
                </a>
                <a class="btn-kitsch secondary-btn-kitsch color5-kitsch retro-shadow-kitsch-small" href="/login"
                   th:href="@{/login}"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a>
                <a class="btn-kitsch primary-btn-kitsch retro-shadow-kitsch-small" href="/signup"
                   th:href="@{/signup}"><i class="fas fa-user-plus"></i> íšŒì›ê°€ì…</a>
            </div>
        </div>
    </div>
    <div class="category-container">
        <div class="categories-panel-kitsch">
            <div class="category-tree-container"></div>
        </div>
    </div>


    <div class="header-marquee-kitsch">
        <p class="pixel-font-kitsch">âœ¨ BlueBooktleì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ì‹ ê°„ ë„ì„œ & ì´ë²¤íŠ¸ í™•ì¸! âœ¨</p>
    </div>

    <script>
        document.querySelectorAll('.categories-btn-header-kitsch').forEach(btn => {
            const panel = btn.closest('.site-header-kitsch')
                .querySelector('.categories-panel-kitsch');
            const icon = btn.querySelector('i');

            btn.addEventListener('click', e => {
                e.preventDefault();
                const isOpen = panel.classList.toggle('active');
                btn.setAttribute('aria-expanded', isOpen);

                if (isOpen) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });

            // ë°– í´ë¦­ ì‹œ ë‹«ê¸°
            document.addEventListener('click', e => {
                if (!btn.contains(e.target) && !panel.contains(e.target)) {
                    panel.classList.remove('active');
                    btn.setAttribute('aria-expanded', 'false');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });
        });
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const data = /*[[${categoryTree}]]*/ [];

        /*]]>*/

        function makeTree(nodes) {
            return nodes.map(cat => {
                const detail = document.createElement('details');
                const sum = document.createElement('summary');

                // leaf ë©´ í´ë˜ìŠ¤ ë‹¬ê¸°
                if (!cat.children || cat.children.length === 0) {
                    detail.classList.add('leaf-category');
                }

                // existing arrow + toggle ë¡œì§â€¦
                if (cat.children && cat.children.length) {
                    const arrow = document.createElement('i');
                    arrow.className = 'fas fa-chevron-right arrow-icon';
                    sum.appendChild(arrow);
                    detail.addEventListener('toggle', () => {
                        arrow.classList.replace(
                            detail.open ? 'fa-chevron-right' : 'fa-chevron-down',
                            detail.open ? 'fa-chevron-down' : 'fa-chevron-right'
                        );
                    });
                }

                // ğŸ“– ì•„ì´ì½˜ + ë§í¬
                const link = document.createElement('a');
                link.href = `/categories/${cat.id}`;            // ì‹¤ì œ ì¹´í…Œê³ ë¦¬ URL íŒ¨í„´ì— ë§ê²Œ ìˆ˜ì •
                link.innerHTML = `ğŸ“– ${cat.name}`;
                link.classList.add('category-link-kitsch');     // í•„ìš”í•˜ë‹¤ë©´ ìŠ¤íƒ€ì¼ìš© í´ë˜ìŠ¤
                // í´ë¦­í•´ë„ details í† ê¸€ì€ ë§‰ê¸°
                link.addEventListener('click', e => e.stopPropagation());
                sum.appendChild(link);

                detail.appendChild(sum);

                // 3) ì¬ê·€ ìì‹ ì²˜ë¦¬
                if (cat.children && cat.children.length) {
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('categories-list-nested');
                    makeTree(cat.children).forEach(child => wrapper.appendChild(child));
                    detail.appendChild(wrapper);
                }

                return detail;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.category-tree-container');
            makeTree(data).forEach(el => container.appendChild(el));
        });

    </script>

</header>


</body>
</html>
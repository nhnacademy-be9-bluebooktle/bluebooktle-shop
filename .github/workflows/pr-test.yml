name: PR Test - Maven

on:
  pull_request:
    branches: [ "develop", "master" ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # SonarQube PR ë¶„ì„ ì‹œ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”
          fetch-depth: 0

      - name: Set up Redis
        uses: supercharge/redis-github-action@1.7.0
        with:
          redis-version: 'latest'

      # 2. JDK 21 ì„¤ì • ë° Maven ìºì‹œ
      - name: Set up JDK 21 and Maven Cache
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ì»¤ë²„ë¦¬ì§€ ìƒì„± ë° SonarQube ë¶„ì„
      - name: Build, Test, Generate Coverage & Analyze with SonarQube
        run: |
          mvn -B clean verify sonar:sonar \
            -Dsonar.projectKey=bluebooktle \
            -Dsonar.projectName='bluebooktle' \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
            -Dsonar.pullrequest.key=${{ github.event.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }} \
            -Dsonar.scm.revision=${{ github.event.pull_request.head.sha }}

      # 4. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê²Œì‹œ
      - name: Publish Unit Test Results
        if: success() # ë˜ëŠ” always() - SonarQube ë¶„ì„ ì‹¤íŒ¨ì™€ ê´€ê³„ì—†ì´ ê²Œì‹œí•˜ê³  ì‹¶ë‹¤ë©´
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: "**/target/surefire-reports/**/*.xml"

      # 5. PR ì½”ë©˜íŠ¸ì— ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ê²Œì‹œ
      - name: Publish JaCoCo Coverage Report
        uses: madrapps/jacoco-report@v1.6.1
        if: always() # SonarQube ë¶„ì„ì´ ì‹¤íŒ¨í•˜ë”ë¼ë„ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ëŠ” ê²Œì‹œ
        with:
          paths: ${{ github.workspace }}/coverage-report/target/site/jacoco-aggregate/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 40
          min-coverage-changed-files: 60
          update-comment: true
          skip-if-no-changes: false
          title: 'ğŸ“Š Code Coverage Report (Aggregated)'
          debug-mode: false
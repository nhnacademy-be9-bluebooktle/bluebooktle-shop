name: PR Test - Maven

on:
  pull_request:
    branches: [ "develop", "master" ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. JDK 21 & Maven ìºì‹œ
      - name: Set up JDK 21 and Maven Cache
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. ì „ì²´ ë¹Œë“œÂ·í…ŒìŠ¤íŠ¸Â·ì§‘ê³„ ë¦¬í¬íŠ¸ ìƒì„±
      - name: Build, Test & Generate Coverage
        run: mvn -B clean verify

      # 4. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê²Œì‹œ
      - name: Publish Unit Test Results
        if: success()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: "**/target/surefire-reports/**/*.xml"

      # 5. jacoco.exec ìœ„ì¹˜ ë””ë²„ê·¸
      - name: Debug jacoco.exec locations
        run: |
          echo "---- Found exec files ----"
          find . -name jacoco.exec -ls
          echo "--------------------------"

      # 6. ì§‘ê³„ëœ JaCoCo XML í™•ì¸
      - name: Check JaCoCo Aggregate XML
        if: success()
        run: |
          REPORT_PATH="${{ github.workspace }}/coverage-report/target/site/jacoco-aggregate/jacoco.xml"
          echo "Looking for ${REPORT_PATH}"
          if [[ -f "$REPORT_PATH" ]]; then
            echo "File exists, head 20 lines:"
            head -n 20 "$REPORT_PATH"
            echo "Coverage counters >0:"
            grep '<counter ' "$REPORT_PATH" | grep 'covered="[1-9]' || echo "No coverage >0 found"
          else
            echo "ERROR: Aggregated report not found!"
            echo "Workspace files:"
            ls -R .
            exit 1
          fi

      # 7. PR ì½”ë©˜íŠ¸ì— ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ê²Œì‹œ
      - name: Publish JaCoCo Coverage Report
        uses: madrapps/jacoco-report@v1.6.1
        if: always()
        with:
          paths: ${{ github.workspace }}/coverage-report/target/site/jacoco-aggregate/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 40
          min-coverage-changed-files: 60
          update-comment: true
          skip-if-no-changes: false
          title: 'ğŸ“Š Code Coverage Report (Aggregated)'
          debug-mode: false
name: PR Test - Maven

on:
  pull_request:
    branches: [ "develop", "master" ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. JDK 21 & Maven 캐시
      - name: Set up JDK 21 and Maven Cache
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. 전체 빌드·테스트·집계 리포트 생성
      - name: Build, Test & Generate Coverage
        run: mvn -B clean verify

      # 4. 단위 테스트 결과 게시
      - name: Publish Unit Test Results
        if: success()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: "**/target/surefire-reports/**/*.xml"

      # 5. jacoco.exec 위치 디버그
      - name: Debug jacoco.exec locations
        run: |
          echo "---- Found exec files ----"
          find . -name jacoco.exec -ls
          echo "--------------------------"

      # 6. 집계된 JaCoCo XML 확인
      - name: Check JaCoCo Aggregate XML
        if: success()
        run: |
          REPORT_PATH="${{ github.workspace }}/coverage-report/target/site/jacoco-aggregate/jacoco.xml"
          echo "Looking for ${REPORT_PATH}"
          if [[ -f "$REPORT_PATH" ]]; then
            echo "File exists, head 20 lines:"
            head -n 20 "$REPORT_PATH"
            echo "Coverage counters >0:"
            grep '<counter ' "$REPORT_PATH" | grep 'covered="[1-9]' || echo "No coverage >0 found"
          else
            echo "ERROR: Aggregated report not found!"
            echo "Workspace files:"
            ls -R .
            exit 1
          fi

      # 7. PR 코멘트에 커버리지 리포트 게시
      - name: Publish JaCoCo Coverage Report
        uses: madrapps/jacoco-report@v1.6.1
        if: always()
        with:
          paths: ${{ github.workspace }}/coverage-report/target/site/jacoco-aggregate/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 40
          min-coverage-changed-files: 60
          update-comment: true
          skip-if-no-changes: false
          title: '📊 Code Coverage Report (Aggregated)'
          debug-mode: false